# ERP系统业务流程对齐报告

**检查时间**: 2025-10-31  
**检查人**: AI助手  
**后端版本**: erp-core + erp-code

---

## 🚨 严重问题（必须修复）

### 1. ❌ 订单列表可以直接创建订单
**问题描述**：
- 订单列表页有"新增订单"按钮
- 可以绕过客户直接创建订单
- 违反了业务流程闭环

**业务流程要求**：
```
客户管理 → 客户详情 → 转订单（选择套餐）→ 创建订单
```

**修复状态**: ✅ **已修复**
- 移除了"新增订单"按钮
- 添加了提示信息：引导用户通过客户管理创建订单

---

### 2. ❌ 订单列表字段与后端实体不匹配
**问题描述**：
- 使用了错误的字段名：`contractDate`, `startDate`, `endDate`, `number`, `customerPhone`, `customerAddress`
- 后端实际字段：`signedAt`, `startedAt`, `completedAt`, `orderNo`, `customerName`

**修复建议**: 
- 简化订单列表，移除编辑功能
- 详情查看跳转到订单详情页
- 只保留列表展示和搜索功能

---

## ⚠️ 设计矛盾（需要澄清）

### 3. ❓ 套餐管理(Product)的矛盾
**矛盾情况**：
- ✅ 后端有`Product`实体表
- ✅ 前端对接文档提到`order_create_from_product`流程
- ❌ 简化版业务流程文档**未提及套餐**
- ✅ 前端已实现套餐管理模块

**业务流程对比**：

| 文档 | 套餐概念 | 订单创建方式 |
|------|---------|-------------|
| 简化版流程 | ❌ 无 | `order_create_draft`（从明细创建） |
| 完整版流程 | ❓ 未明确 | 未说明 |
| 前端对接文档 | ✅ 有 | `order_create_from_product`（从套餐创建） |

**需要确认**：
1. 是否使用套餐功能？
2. 如果使用，套餐和订单明细的关系是什么？
3. 是否可以不选套餐，直接从明细创建订单？

---

### 4. ❓ 项目管理(Project)的矛盾
**矛盾情况**：
- ✅ 后端有`Project`实体表
- ✅ 完整版业务流程文档有完整的项目管理流程
- ❌ 简化版业务流程文档**明确说明"去除项目表"**
- ✅ 前端菜单有"项目管理"

**简化版文档说明**：
> 遵循"不过度设计，业务闭环，流程精简"原则，去除冗余的项目（Project）概念，让订单（Order）直接承载施工管理职责。

**核心变化**：
- **简化前**：订单 → 项目 → 施工管理
- **简化后**：订单直接管理施工（`foremanId`, `startedAt`, `completedAt`）

**需要确认**：
1. 是否使用简化版（去除项目表）？
2. 如果不使用，前端项目管理页面需要实现哪些功能？

---

## 🔧 代码流程缺失问题

### 5. ❌ 业务流程代码未实现
**erp-code项目状况**：
- ✅ 只实现了：`客户创建` 流程
- ❌ 缺失的关键流程：

| 流程key | 流程名称 | 前端调用情况 | 状态 |
|---------|---------|-------------|------|
| `customer_measure` | 客户量房 | ✅ 已调用 | ❌ 未实现 |
| `order_create_from_product` | 从套餐创建订单 | ✅ 已调用 | ❌ 未实现 |
| `order_material_update` | 更新订单明细 | ✅ 已调用 | ❌ 未实现 |
| `order_sign` | 订单签约 | ✅ 已调用 | ❌ 未实现 |
| `order_start` | 订单开工 | ✅ 已调用 | ❌ 未实现 |
| `order_complete` | 订单完工 | ✅ 已调用 | ❌ 未实现 |
| `payment_confirm` | 确认收款 | ✅ 已调用 | ❌ 未实现 |

**影响**：
- 前端功能无法正常工作
- 所有业务流程操作会报错
- 状态流转无法自动进行

**修复建议**：
需要在`erp-code`项目中实现这些流程，或者使用erp-core的基础CRUD接口 + 前端逻辑实现状态流转。

---

## ✅ 已对齐的功能

### 6. ✅ 客户管理模块
- ✅ 客户列表（增删改查）
- ✅ 客户详情弹窗
- ✅ 量房功能（调用`customer_measure`）
- ✅ 转订单功能（调用`order_create_from_product`）
- ✅ 根据客户状态显示不同操作按钮

### 7. ✅ 订单详情页
- ✅ 订单基本信息展示
- ✅ 订单明细增删改
- ✅ 金额统计（总额、已收、未收、成本）
- ✅ 状态流转按钮（签约、开工、完工）
- ✅ 调用对应的codeflow API

### 8. ✅ 收款管理模块
- ✅ 收款列表
- ✅ 确认收款功能（调用`payment_confirm`）
- ✅ 收款状态显示

### 9. ✅ 枚举常量对齐
- ✅ 所有枚举与后端完全一致
- ✅ 状态标签和颜色映射完善

---

## 📋 后续行动计划

### 紧急优先级（P0）

1. **确认业务流程版本**
   - [ ] 确认使用简化版还是完整版
   - [ ] 确认是否使用套餐管理
   - [ ] 确认是否使用项目管理

2. **修复订单列表页**
   - [x] 移除"新增订单"按钮 ✅
   - [ ] 修复字段映射错误
   - [ ] 简化编辑功能或移除

3. **实现业务流程代码**
   - [ ] 实现7个关键codeflow流程
   - [ ] 或改用基础CRUD + 前端逻辑

### 高优先级（P1）

4. **订单明细API确认**
   - [ ] 确认后端是否有订单明细的增删改查接口
   - [ ] 前端订单详情页需要这些接口

5. **测试业务闭环**
   - [ ] 测试完整流程：客户 → 订单 → 收款
   - [ ] 验证状态自动流转
   - [ ] 验证数据联动（金额计算等）

---

## 🎯 推荐方案

### 方案A：简化版（推荐）✨

**特点**：
- 去除项目表，订单直接管理施工
- 使用套餐快速创建订单（可选）
- 业务流程精简、易维护

**优势**：
- 符合简化业务流程文档
- 开发量小
- 维护成本低

**需要调整**：
1. 移除前端"项目管理"菜单
2. 订单详情页增加施工管理字段（工长、开工时间、完工时间）
3. 实现7个核心codeflow流程

---

### 方案B：完整版

**特点**：
- 保留项目表
- 订单 → 项目 → 施工
- 完整的项目管理功能

**需要实现**：
1. 项目管理页面（创建、编辑、删除）
2. 项目状态流转
3. 订单和项目的关联管理
4. 更多的codeflow流程

---

## 💡 建议

根据"**不过度设计，业务闭环，流程精简**"的原则，建议：

1. ✅ **采用简化版** - 去除项目管理，订单直接管理施工
2. ✅ **保留套餐管理** - 方便快速创建标准订单
3. ✅ **优先实现核心业务流程** - 7个关键codeflow
4. ✅ **简化订单列表页** - 移除复杂编辑功能

---

**报告完成时间**: 2025-10-31  
**下一步**: 等待确认业务流程版本，然后继续修复

