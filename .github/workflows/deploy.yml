name: Deploy erp-web

# 触发条件: 推送到 master 分支或手动触发
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 登录阿里云容器镜像服务
      - name: Login to Aliyun Container Registry
        uses: aliyun/acr-login@v1
        with:
          login-server: https://${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 3. 构建并推送 Docker 镜像
      - name: Build and push Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building image with tag: $IMAGE_TAG"
          docker build -t ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/erp-web:$IMAGE_TAG .
          docker push ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/erp-web:$IMAGE_TAG

          # 同时推送 latest 标签
          docker tag ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/erp-web:$IMAGE_TAG \
                     ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/erp-web:latest
          docker push ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/erp-web:latest

      # 4. 准备部署文件
      - name: Prepare deployment files
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # 替换 docker-compose.prod.yml 中的镜像标签
          sed -i "s|{{IMAGE_TAG}}|$IMAGE_TAG|g" docker-compose.prod.yml

      # 5. 上传配置文件到服务器
      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "docker-compose.prod.yml"
          target: /app/erp-web/

      # 6. SSH 到服务器部署
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            cd /app/erp-web

            # 设置环境变量
            export ACR_REGISTRY="${{ secrets.ACR_REGISTRY }}"
            export ACR_NAMESPACE="${{ secrets.ACR_NAMESPACE }}"

            # 登录 ACR
            docker login --username=${{ secrets.ACR_USERNAME }} \
                        --password=${{ secrets.ACR_PASSWORD }} \
                        ${{ secrets.ACR_REGISTRY }}

            # 拉取最新镜像
            docker compose -f docker-compose.prod.yml pull

            # 停止旧容器
            docker compose -f docker-compose.prod.yml down || true

            # 启动新容器
            docker compose -f docker-compose.prod.yml up -d

            # 等待容器启动
            sleep 5

            # 查看状态
            docker compose -f docker-compose.prod.yml ps

            echo "✅ erp-web 部署完成!"
