# ERP Web 前端架构说明

## 角色定位

erp-web 是 ERP 系统的**前端服务**，提供：
- 静态资源服务（HTML/CSS/JS）
- SPA 路由支持
- API 请求代理到后端

## 架构图

```
              用户浏览器
                  │
                  ▼
           nginx-gateway
          (erp.lytt.fun)
                  │
                  ▼
        ┌─────────────────┐
        │    erp-web      │ ◄── 本服务
        │  (nginx容器)     │
        └─────────────────┘
                  │
                  │ /api/* 请求代理
                  ▼
        ┌─────────────────┐
        │   erp-core      │
        │  (后端 API)      │
        └─────────────────┘
```

## 请求流程

```
1. 用户访问 erp.lytt.fun
          │
          ▼
2. nginx-gateway 转发到 erp-web:80
          │
          ▼
3. erp-web nginx 处理请求：
   ├── 静态资源 (/, *.js, *.css) → 返回前端文件
   └── API 请求 (/api/*) → 代理到 erp-core:3009
```

## 网络配置

| 网络 | 用途 |
|------|------|
| `erp-db-network` | ERP 共享网络，可访问 erp-core |

**注意**：本服务不对外暴露端口，只能通过 nginx-gateway 访问。

## Nginx 配置说明 (nginx.conf)

```nginx
# SPA 路由支持 - 所有路径都返回 index.html
location / {
    try_files $uri $uri/ /index.html;
}

# API 代理 - 转发到后端服务
location /api/ {
    proxy_pass http://erp-core:3009/api/;
}

# 静态资源缓存 - 1年缓存
location ~* \.(js|css|png|jpg|...)$ {
    expires 1y;
}
```

## 文件结构

```
erp-web/
├── docker-compose.prod.yml   # 生产环境 Docker 配置
├── Dockerfile                # Docker 构建文件
├── nginx.conf                # Nginx 配置 (SPA路由 + API代理)
├── packages/
│   └── main/                 # 前端源码
├── package.json
├── pnpm-workspace.yaml
└── ARCHITECTURE.md           # 本文档
```

## Docker 构建流程

```dockerfile
# 1. 构建阶段 - 编译前端代码
FROM node:18-alpine AS builder
RUN pnpm install && pnpm build

# 2. 生产阶段 - Nginx 静态服务
FROM nginx:alpine
COPY --from=builder /app/packages/main/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
```

## 部署方式

通过 GitHub Actions 自动部署：

1. 推送代码到 master 分支
2. 构建 Docker 镜像并推送到阿里云 ACR
3. 服务器拉取镜像并重启容器

## 环境变量

本服务不需要环境变量，所有配置都在 nginx.conf 中。

## 依赖关系

| 依赖服务 | 说明 |
|----------|------|
| `erp-core` | API 代理目标，必须先启动 |
| `nginx-gateway` | 入口网关，负责转发请求到本服务 |

**部署顺序**：`db-app` → `erp-core` → `erp-web` → `nginx-app`
